<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Planner Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* macOS Inspired Theme */
        :root {
            --macos-bg-light: #f6f6f6; 
            --macos-bg-medium: #ececec; 
            --macos-border: #c9c9c9; 
            --macos-text-primary: #333333;
            --macos-text-secondary: #757575;
            --macos-blue-accent: #007aff;
            --macos-blue-accent-hover: #0056b3;
            --macos-red-accent: #ff3b30;
            --macos-green-accent: #34c759;
            --macos-yellow-accent: #ffcc00;
            --macos-orange-accent: #ff9500;
            --macos-window-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 5px 15px rgba(0,0,0,0.08);
            --macos-button-shadow: 0 1px 1px rgba(0,0,0,0.05);
            --header-shadow: 0 1px 2px rgba(0,0,0,0.05), 0 1px 1px rgba(0,0,0,0.03);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--macos-bg-medium); 
            color: var(--macos-text-primary);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; 
            font-size: 0.70rem; 
            font-weight: 500; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid transparent;
        }
        .status-pending { background-color: #fffbe6; color: #d97706; border-color: #fde68a;} 
        .status-inprogress { background-color: #f0fdfa; color: #0d9488; border-color: #99f6e4;} 
        .status-completed { background-color: #f0fdf4; color: #16a34a; border-color: #a7f3d0;} 
        .status-overdue { background-color: #fff1f2; color: #e11d48; border-color: #fecdd3;} 
        .status-workdoneintime { background-color: #f0fdf4; color: #16a34a; border-color: #a7f3d0;} 
        .status-worknotdoneintime { background-color: #fff7ed; color: #f97316; border-color: #fed7aa;} 

        .admin-badge {
            margin-left: 0.5rem;
            padding: 0.125rem 0.5rem; 
            font-size: 0.7rem; 
            font-weight: 600;
            color: white;
            background-color: #6366f1; 
            border-radius: 9999px;
            vertical-align: middle; 
        }
        .task-card {
            background-color: #ffffff;
            border: 1px solid var(--macos-border);
            border-radius: 8px; 
            box-shadow: var(--macos-window-shadow);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08), 0 10px 20px rgba(0,0,0,0.1);
        }
        ::-webkit-scrollbar { width: 7px; height: 7px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #b3b3b3; }

        .date-tag { font-size: 0.8rem; padding: 0.15rem 0.5rem; border-radius: 4px; font-weight: 500; }
        
        .input-field, .search-input, .filter-select, input[type="date"] {
            background-color: #ffffff;
            border: 1px solid var(--macos-border);
            border-radius: 6px; 
            padding: 0.6rem 0.75rem; 
            font-size: 0.875rem;
            color: var(--macos-text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
            height: 40px; 
        }
        .input-field:focus, .search-input:focus, .filter-select:focus, input[type="date"]:focus {
            outline: none;
            border-color: var(--macos-blue-accent); 
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25);
        }
        .search-input { padding-left: 2.5rem; }


        .loader {
            border: 4px solid #e0e0e0; border-top: 4px solid var(--macos-blue-accent);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        .sync-loader { 
            border-width: 2px;
            width: 16px;
            height: 16px;
            margin: 0;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loadingState { text-align: center; padding: 1rem; font-size: 1.1rem; color: var(--macos-text-secondary); }
        
        #loginPageContainer {
            background-color: var(--macos-bg-light);
            padding: 2rem; 
            border-radius: 10px; 
            box-shadow: var(--macos-window-shadow); 
            width: 90%; 
            max-width: 400px; 
            text-align: center;
            border: 1px solid #d9d9d9;
        }
        #loginPageContainer h2 { color: var(--macos-text-primary); font-size: 1.5rem; }
        #loginPageContainer p { color: var(--macos-text-secondary); font-size: 0.875rem; }
        #loginButton {
            background-color: var(--macos-blue-accent);
            color: white;
            font-weight: 500;
            border-radius: 6px;
            padding: 0.75rem 1.5rem; 
            box-shadow: var(--macos-button-shadow);
            transition: background-color 0.2s;
        }
        #loginButton:hover { background-color: var(--macos-blue-accent-hover); }
        #loginButton:disabled { background-color: #b3d7ff; cursor: not-allowed; }


        #loginLoadingState, #initialAppLoadingState { 
            text-align: center; 
            padding-top: 0.5rem; 
            padding-bottom: 0.5rem; 
            font-size: 0.9rem; 
            color: var(--macos-text-secondary);
        }
        #dashboardWrapper.hidden, #loginPageContainer.hidden, #taskTableContainer.hidden, #taskGrid.hidden, #noTasksMessage.hidden, #loadingState.hidden, #errorState.hidden, #adminFilterContainer.hidden, #initialAppLoadingState.hidden, #loginLoadingState.hidden, #dateFilterContainer.hidden, #statusFilterContainer.hidden, #userNameFilterContainer.hidden, #exportPdfButton.hidden { 
            display: none; 
        }
        
        body.dashboard-visible {
            display: block; 
            align-items: initial;
            justify-content: initial;
            background-color: var(--macos-bg-medium); 
        }
        
        #toastNotification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #toastNotification.show {
            opacity: 1;
            bottom: 30px;
        }
        #toastNotification.success { background-color: var(--macos-green-accent); } 
        #toastNotification.error { background-color: var(--macos-red-accent); } 

        .filter-button { 
            padding: 0.5rem 0.9rem; 
            border: 1px solid var(--macos-border); 
            border-radius: 6px; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--macos-text-primary); 
            background-color: #ffffff;
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, color 0.15s ease-in-out;
            cursor: pointer;
            white-space: nowrap; 
            height: 40px; 
        }
        .filter-button:hover {
            border-color: #b3b3b3;
            background-color: #f9f9f9; 
        }
        .filter-button.active {
            background-color: var(--macos-blue-accent); 
            color: white;
            border-color: var(--macos-blue-accent);
        }
        .filter-button:not(:last-child) {
            margin-right: 0.5rem; 
        }
        #taskTableContainer table {
            width: 100%; 
            table-layout: auto; 
            border-collapse: collapse;
            background-color: #ffffff;
            box-shadow: var(--macos-window-shadow);
            border-radius: 8px;
            overflow: hidden; 
            border: 1px solid var(--macos-border);
        }
        #taskTableContainer th, #taskTableContainer td {
            border-bottom: 1px solid var(--macos-border); 
            border-left: 0; border-right: 0; 
            padding: 0.6rem 0.5rem; 
            text-align: left;
            font-size: 0.75rem; 
            white-space: normal; 
            word-break: break-word; 
        }
        @media (min-width: 640px) { 
            #taskTableContainer th, #taskTableContainer td {
                font-size: 0.8rem; 
                padding: 0.75rem 0.75rem; 
                white-space: nowrap; 
            }
        }
        @media (min-width: 1024px) { 
            #taskTableContainer th, #taskTableContainer td {
                font-size: 0.875rem; 
                padding: 0.85rem 1rem; 
            }
        }

        #taskTableContainer th {
            background-color: #f9f9f9; 
            font-weight: 500; 
            color: var(--macos-text-primary); 
            border-top: 0;
        }
        #taskTableContainer tbody tr:nth-child(even) {
            background-color: #fdfdfd; 
        }
        #taskTableContainer tbody tr:hover {
            background-color: #f0f8ff; 
        }
        #taskTableContainer .update-link-container a { 
             display: inline-block; 
             padding: 0.375rem 0.75rem; 
        }
        input[type="date"] { height: 40px; }

        .filter-select {
             -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 2.5rem; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23757575'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            height: 40px;
        }
        
        /* macOS-like Header */
        #dashboardWrapper > header {
            background-color: var(--macos-bg-light);
            border-bottom: 1px solid var(--macos-border);
            box-shadow: var(--header-shadow); 
        }
        #dashboardWrapper > header h1 {
            color: var(--macos-text-primary);
            font-weight: 600; 
        }
        #dashboardWrapper > header .text-slate-500 { color: var(--macos-text-secondary); } 
        #dashboardWrapper > header .text-slate-600 { color: var(--macos-text-primary); } 
        #dashboardWrapper > header #userAvatar { border-color: var(--macos-blue-accent); }
        #dashboardWrapper > header button[title] { 
            color: var(--macos-text-secondary);
            padding: 0.5rem;
            border-radius: 6px;
        }
         #dashboardWrapper > header button[title]:hover {
            background-color: rgba(0,0,0,0.05);
            color: var(--macos-text-primary);
        }
        
        #dashboardWrapper > main {
            background-color: var(--macos-bg-medium); 
        }

        #addTaskButtonLink {
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            background-color: var(--macos-blue-accent);
            color: white;
            font-weight: 500; 
            font-size: 0.875rem; 
            border-radius: 6px; 
            padding: 0 1rem; 
            height: 40px; 
            text-decoration: none; 
            box-shadow: var(--macos-button-shadow);
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        #addTaskButtonLink:hover {
            background-color: var(--macos-blue-accent-hover);
            box-shadow: 0 1px 2px rgba(0,0,0,0.08); 
        }
        #addTaskButtonLink[aria-disabled="true"] {
            background-color: #add8e6; 
            color: #ffffffa0; 
            cursor: not-allowed;
            box-shadow: none;
        }
        #addTaskButtonLink[aria-disabled="true"] i {
            color: #ffffffa0; 
        }
        #addTaskButtonLink i {
            margin-right: 0.5rem; 
        }
        #exportPdfButton {
             height: 40px;
             padding: 0 1rem;
        }
        #exportPdfButton.hidden { display: none; } 

        .summary-card-icon {
            font-size: 1.25rem; /* text-xl */
            margin-right: 0.75rem; /* mr-3 */
        }
        
        /* New Filter Layout Styles */
        .filter-section-container {
            background-color: #ffffff; /* Card background */
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: var(--macos-window-shadow);
            border: 1px solid var(--macos-border);
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* Default to 1 column */
            gap: 1rem; /* gap-4 */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .filter-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 columns on medium */
            }
        }
        @media (min-width: 1280px) { /* xl breakpoint */
            .filter-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* 3 columns on large */
            }
             .filter-item-search { grid-column: span 1 / span 1; }
             .filter-item-admin-view { grid-column: span 2 / span 2; }
             .filter-item-user-filter { grid-column: span 1 / span 1; }
             .filter-item-date-range { grid-column: span 2 / span 2; }
             .filter-item-status { grid-column: span 1 / span 1; }
        }
        .filter-item label {
            display: block;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            color: var(--macos-text-secondary);
            margin-bottom: 0.25rem; /* mb-1 */
        }
        .filter-item .input-field, .filter-item .search-input, .filter-item .filter-select {
            width: 100%;
        }
        .action-buttons-group {
            margin-top: 1rem; /* Space above action buttons */
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; /* gap-3 */
            justify-content: flex-start; /* Align to start by default */
        }
        @media (min-width: 768px) {
             .action-buttons-group {
                justify-content: flex-end; /* Align to end on larger screens */
            }
        }
        .action-buttons-group > * {
            flex-grow: 1; /* Buttons take available space on small screens */
        }
         @media (min-width: 640px) { /* sm breakpoint */
             .action-buttons-group > * {
                flex-grow: 0; /* Buttons take their own width on larger screens */
            }
        }


    </style>
</head>
<body class="antialiased text-slate-700">

    <div id="loginPageContainer">
        <div class="mb-6 text-center">
            <i class="fas fa-calendar-check text-5xl text-blue-600 mb-3"></i>
            <h2 class="text-2xl font-bold">Weekly Planner Login</h2>
            <p class="text-sm mt-1">Please enter your email to access the dashboard.</p>
        </div>
        <div id="initialAppLoadingState" class="hidden"> 
             <div class="loader" style="width:30px; height:30px; border-width:3px; margin-top:0; margin-bottom: 10px;"></div>
             <p>Loading application data...</p>
        </div>
        <div id="loginLoadingState" class="hidden"> 
             <div class="loader" style="width:30px; height:30px; border-width:3px; margin-top:0; margin-bottom: 10px;"></div>
             <p>Verifying credentials...</p>
        </div>
        <form id="loginForm">
            <div class="mb-4">
                <label for="emailInput" class="block text-sm font-medium text-left mb-1">Email Address</label>
                <input type="email" id="emailInput" name="email" required
                       class="input-field w-full"
                       placeholder="your.email@example.com">
            </div>
            <button type="submit" id="loginButton"
                    class="w-full text-white font-semibold flex items-center justify-center">
                <i class="fas fa-sign-in-alt mr-2"></i> Login
            </button>
        </form>
        <p id="loginErrorMessage" class="mt-4 text-sm text-red-600"></p>
         <p class="mt-6 text-xs text-slate-400">&copy; <span id="loginCurrentYear"></span> BuildWealthRealtors</p>
    </div>

    <div id="dashboardWrapper" class="hidden min-h-screen flex-col w-full">
        <header class="sticky top-0 z-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row items-center justify-between h-auto sm:h-16 py-2 sm:py-0">
                    <div class="flex items-center mb-2 sm:mb-0">
                        <i class="fas fa-calendar-alt text-2xl text-blue-600 mr-3"></i>
                        <h1 class="text-xl font-semibold">Weekly Planner</h1>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-3">
                        <div class="text-right">
                            <p id="userNameDisplay" class="text-sm font-medium">Welcome, User!</p>
                            <p id="currentWeekDisplay" class="text-xs">Current Week: N/A</p>
                        </div>
                        <img id="userAvatar" src="https://placehold.co/32x32/E2E8F0/4A5568?text=U" alt="User Avatar" class="w-8 h-8 sm:w-9 sm:h-9 rounded-full object-cover border-2">
                        <button id="syncDataButton" title="Sync Data" class="disabled:opacity-50 disabled:cursor-not-allowed p-1 sm:p-2">
                            <i class="fas fa-sync-alt text-base sm:text-lg"></i>
                        </button>
                        <button id="logoutButton" title="Logout" class="p-1 sm:p-2">
                            <i class="fas fa-sign-out-alt text-base sm:text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <section id="summaryStats" class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            </section>

            <section class="filter-section-container">
                <div class="filter-grid">
                    <div class="filter-item filter-item-search">
                        <label for="searchInput">Search</label>
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Search tasks or users..."
                                   class="search-input w-full"
                                   aria-label="Search tasks" disabled>
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <div id="adminFilterContainer" class="filter-item filter-item-admin-view hidden"> 
                        <label>Admin Task View</label>
                        <div class="flex items-center">
                            <button id="viewMyTasksButton" class="filter-button active" data-view="self">My Tasks</button> 
                            <button id="viewAllTasksButton" class="filter-button" data-view="all">All Tasks</button>
                        </div>
                    </div>

                    <div id="userNameFilterContainer" class="filter-item filter-item-user-filter hidden">
                        <label for="userNameFilterSelect">Filter by User</label>
                        <select id="userNameFilterSelect" class="filter-select w-full">
                            <option value="all_users">All Users</option>
                        </select>
                    </div>

                     <div id="dateFilterContainer" class="filter-item filter-item-date-range">
                        <label>Filter by Planned Date</label>
                        <div class="flex flex-col sm:flex-row gap-2 items-center">
                            <input type="date" id="startDateFilter" class="input-field w-full sm:w-1/2" aria-label="Start Date">
                            <span class="text-gray-500 hidden sm:inline">-</span>
                            <input type="date" id="endDateFilter" class="input-field w-full sm:w-1/2" aria-label="End Date">
                        </div>
                    </div>
                    
                    <div id="statusFilterContainer" class="filter-item filter-item-status"> 
                        <label for="statusFilterSelect">Filter by Status</label>
                        <select id="statusFilterSelect" class="filter-select w-full">
                            <option value="active">Active Tasks</option>
                            <option value="completed_group">Completed (All)</option> 
                            <option value="completed_in_time">Completed - In Time</option>
                            <option value="completed_not_in_time">Completed - Not In Time</option>
                            <option value="all">All Tasks (Active/Completed)</option>
                        </select>
                    </div>
                </div>
                
                <div class="action-buttons-group">
                     <button id="clearFiltersButton" class="filter-button bg-gray-200 hover:bg-gray-300 text-gray-700">
                        <i class="fas fa-times-circle mr-2"></i>Clear Filters
                    </button>
                     <button id="exportPdfButton" class="filter-button bg-gray-200 hover:bg-gray-300 text-gray-700 hidden">
                        <i class="fas fa-file-pdf mr-2"></i>Export to PDF
                    </button>
                    <a id="addTaskButtonLink" href="https://docs.google.com/forms/d/e/1FAIpQLSfjcKJcjfd3y09GiEv8Vy4ZED2i54s4l_EnvYAtBKMZenomDA/viewform" target="_blank"
                       aria-label="Add New Task" role="button" aria-disabled="true">
                        <i class="fas fa-plus"></i> Add New Task
                    </a>
                </div>
            </section>


            <div id="loadingState" class="hidden">
                <div class="loader"></div>
                <p>Loading tasks...</p>
            </div>
            <div id="errorState" class="hidden text-center text-red-600 bg-red-100 p-4 rounded-lg">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p id="errorMessage">Could not load tasks. Please try again later.</p>
            </div>
            
            <section id="taskGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></section>
            
            <section id="taskTableContainer" class="hidden overflow-x-auto"></section>

            <div id="noTasksMessage" class="hidden text-center text-slate-500 py-10">
                <i class="fas fa-folder-open fa-3x mb-3"></i>
                <p id="noTasksMessageText" class="text-xl">No tasks found for your account.</p>
                <p>You can add a new task using the button above.</p>
            </div>
        </main>

        <footer class="bg-white border-t border-slate-200 mt-auto">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-sm text-slate-500">
                &copy; <span id="dashboardCurrentYear"></span> Weekly Planner Dashboard. All rights reserved.
            </div>
        </footer>
    </div>
    
    <div id="toastNotification" class=""></div>

    <script>
        // --- API Configuration ---
        const PLANNER_API_URL = 'https://script.googleusercontent.com/a/macros/buildwealthrealtors.com/echo?user_content_key=AehSKLinRc-ob6PmvqztEyycNpZjrccxhyqdnWVQRYfIZiQMmMqTrYIZE0v0Np0Dy3Glfo4yrRteUS58ikzZNBsqKz8mKa7fN0qVZHqMFY2-MGwDdMksaZ101-GVrqO7D1zWTLp2tbzcMlXlgBLoSKPmhMK5VqkQb_YzqR1pmp1uXgFWjdaj213xA3l6Gusb03DgZKNBNiW5u6KabMV3UhYIXy1ydujn7M9QLyPSgTuBgbxNZfNpaAfVndXc1vhwhst30C8lk__ecSI78iFLqTiwzVjT_Xtux0LAi-XOvSwi-G29wOJwMUIP6sWg88wH90DXR4EFjhjt&lib=M7LUUuesu8Tqm4ChggBalAQa_c_o8YQ-H';
        const USER_DETAILS_API_URL = 'https://script.googleusercontent.com/a/macros/buildwealthrealtors.com/echo?user_content_key=AehSKLgvOXeD-ocTEyBPHZ-W6m1hksagkeEWtulWtC_MW7ltYGYEC_Gz5Whg09V3noGvtWe-eFZ9wnGnJdjGT7OXtJqTOlOGvuBWR-Wn7Gn8MLwbwIWYIfw5A9IGaRZgvcAyBbt-BK4OdBDZqs3ziD8D9D8fTjJ3b3vykGSwY5Sy4aV65nF7Wg65pnSk3DuMT2RDVp7iBzNdRrqJeYSpfexVxpd1bnB1xa6_LlpbePJjAh6s939s3IS7PYE7tcHNMHnHwRA8q1vzJg0nLf_nRtTo5qd_EHtmxrfWYMBxMGNnUQbhyR-En22A7F-P9j48TVm6zVDf--FY&lib=M7LUUuesu8Tqm4ChggBalAQa_c_o8YQ-H';
        const ADD_TASK_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfjcKJcjfd3y09GiEv8Vy4ZED2i54s4l_EnvYAtBKMZenomDA/viewform';
        
        let allUsersDataGlobal = [];    
        let allPlannerDataGlobal = [];  
        
        let currentUserEmail = null;
        let currentUserName = null;
        let currentUserRole = null;
        let adminViewPreference = 'self'; 
        let currentStatusFilter = 'active'; 
        let selectedUserEmailFilter = 'all_users'; 

        // --- Utility Functions ---
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                let standardizedDate = dateString;
                if (String(dateString).includes('-') && String(dateString).split('-')[1]?.length === 3) {
                    const parts = String(dateString).split('-');
                    const months = {Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06', Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'};
                    if (parts.length === 3 && months[parts[1]]) {
                         standardizedDate = `${parts[2]}-${months[parts[1]]}-${parts[0]}`;
                    }
                }
                const options = { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' };
                return new Date(standardizedDate).toLocaleDateString(undefined, options);
            } catch (e) {
                console.error("Error formatting date:", dateString, e);
                return String(dateString);
            }
        }

        function getStatusClass(status) {
            if (!status) return 'bg-slate-200 text-slate-700';
            const sLower = String(status).toLowerCase();
            switch (sLower) {
                case 'pending': return 'status-pending';
                case 'inprogress': case 'in progress': return 'status-inprogress';
                case 'completed': return 'status-completed'; 
                case 'work done in time': return 'status-workdoneintime';
                case 'work not done in time': return 'status-worknotdoneintime';
                case 'overdue': return 'status-overdue';
                default: return 'bg-slate-200 text-slate-700';
            }
        }

        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toastNotification');
            toast.textContent = message;
            toast.className = 'show'; 
            if (type === 'success') {
                toast.classList.add('success');
            } else {
                toast.classList.add('error');
            }
            
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, duration);
        }

        function getWeekDateRange(date = new Date()) {
            const today = new Date(date.valueOf());
            const dayOfWeek = today.getDay(); 
            const adjustedDay = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;

            const startDate = new Date(today);
            startDate.setDate(today.getDate() - adjustedDay); 
            startDate.setHours(0, 0, 0, 0);

            const endDate = new Date(startDate); 
            endDate.setDate(startDate.getDate() + 6); 
            endDate.setHours(23, 59, 59, 999);
            
            const formatDateToInput = (d) => d.toISOString().split('T')[0];

            return {
                start: formatDateToInput(startDate),
                end: formatDateToInput(endDate)
            };
        }


        // --- DOM Elements ---
        const loginPageContainer = document.getElementById('loginPageContainer');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('emailInput');
        const loginButton = document.getElementById('loginButton');
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        const initialAppLoadingState = document.getElementById('initialAppLoadingState');
        const loginLoadingState = document.getElementById('loginLoadingState'); 

        const dashboardWrapper = document.getElementById('dashboardWrapper');
        const taskGrid = document.getElementById('taskGrid'); 
        const taskTableContainer = document.getElementById('taskTableContainer'); 
        const searchInput = document.getElementById('searchInput');
        const adminFilterContainer = document.getElementById('adminFilterContainer');
        const viewMyTasksButton = document.getElementById('viewMyTasksButton');
        const viewAllTasksButton = document.getElementById('viewAllTasksButton');
        const userNameFilterContainer = document.getElementById('userNameFilterContainer');
        const userNameFilterSelect = document.getElementById('userNameFilterSelect');
        const dateFilterContainer = document.getElementById('dateFilterContainer');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const statusFilterContainer = document.getElementById('statusFilterContainer');
        const statusFilterSelect = document.getElementById('statusFilterSelect'); 
        const noTasksMessage = document.getElementById('noTasksMessage');
        const noTasksMessageText = document.getElementById('noTasksMessageText'); 
        const userNameDisplay = document.getElementById('userNameDisplay');
        const currentWeekDisplay = document.getElementById('currentWeekDisplay');
        const userAvatar = document.getElementById('userAvatar');
        const summaryStatsContainer = document.getElementById('summaryStats');
        const addTaskButtonLink = document.getElementById('addTaskButtonLink');
        const exportPdfButton = document.getElementById('exportPdfButton'); 
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const logoutButton = document.getElementById('logoutButton');
        const syncDataButton = document.getElementById('syncDataButton');
        
        const loadingStateDiv = document.getElementById('loadingState'); 
        const errorStateDiv = document.getElementById('errorState');
        const errorMessageP = document.getElementById('errorMessage');

        // --- Core Logic: Login and Data Handling ---
        async function fetchLoginPrerequisites() { 
            initialAppLoadingState.classList.remove('hidden');
            loginForm.classList.add('hidden'); 
            loginErrorMessage.textContent = '';
            loginButton.disabled = true; 
            try {
                const response = await fetch(USER_DETAILS_API_URL);
                if (!response.ok) throw new Error(`User API Error: ${response.status}`);
                allUsersDataGlobal = await response.json();
                if (!Array.isArray(allUsersDataGlobal)) {
                    throw new Error('Invalid user data format from API.');
                }
                populateUserNameFilter(); 
                loginButton.disabled = false; 
            } catch (error) {
                console.error('Failed to fetch user details:', error);
                loginErrorMessage.textContent = 'Error loading application. Please try refreshing.';
            } finally {
                initialAppLoadingState.classList.add('hidden');
                loginForm.classList.remove('hidden'); 
            }
        }

        function populateUserNameFilter() {
            userNameFilterSelect.innerHTML = '<option value="all_users">All Users</option>'; 
            if (allUsersDataGlobal && allUsersDataGlobal.length > 0) {
                const sortedUsers = [...allUsersDataGlobal].sort((a, b) => {
                    const nameA = a['Employee Name'] || '';
                    const nameB = b['Employee Name'] || '';
                    return nameA.localeCompare(nameB);
                });

                sortedUsers.forEach(user => {
                    if (user['Employee Name'] && user['Email']) {
                        const option = document.createElement('option');
                        option.value = String(user['Email']).toLowerCase();
                        option.textContent = user['Employee Name'];
                        userNameFilterSelect.appendChild(option);
                    }
                });
            }
        }


        async function fetchAndDisplayPlannerData() {
            dashboardWrapper.classList.remove('hidden'); 
            loadingStateDiv.classList.remove('hidden'); 
            taskGrid.classList.add('hidden');
            taskTableContainer.classList.add('hidden');
            noTasksMessage.classList.add('hidden');
            errorStateDiv.classList.add('hidden');
            syncDataButton.disabled = true; 

            try {
                const response = await fetch(PLANNER_API_URL);
                if (!response.ok) throw new Error(`Planner API Error: ${response.status}`);
                allPlannerDataGlobal = await response.json();
                if (!Array.isArray(allPlannerDataGlobal)) {
                    throw new Error('Invalid planner data format from API.');
                }
                showDashboard(); 
            } catch (error) {
                console.error('Failed to fetch planner data:', error);
                errorMessageP.textContent = `Failed to load tasks: ${error.message}.`;
                errorStateDiv.classList.remove('hidden');
                taskGrid.innerHTML = '';
                taskTableContainer.innerHTML = '';
                summaryStatsContainer.innerHTML = '';
            } finally {
                loadingStateDiv.classList.add('hidden');
                syncDataButton.disabled = false;
            }
        }


        async function handleLogin(event) {
            event.preventDefault();
            const email = emailInput.value.trim().toLowerCase();
            loginErrorMessage.textContent = ''; 

            if (!email) {
                loginErrorMessage.textContent = 'Please enter your email address.';
                return;
            }

            if (allUsersDataGlobal.length === 0) { 
                loginErrorMessage.textContent = 'User data not yet available. Please wait or try refreshing.';
                return;
            }

            loginLoadingState.classList.remove('hidden');
            loginButton.disabled = true; 

            const foundUser = allUsersDataGlobal.find(user => String(user['Email']).toLowerCase() === email);

            if (foundUser) {
                currentUserEmail = String(foundUser['Email']).toLowerCase();
                currentUserName = foundUser['Employee Name']; 
                currentUserRole = foundUser['Role'];
                localStorage.setItem('loggedInUserEmail', currentUserEmail); 
                
                if (currentUserRole && String(currentUserRole).toLowerCase() === 'admin') {
                    adminViewPreference = 'self'; 
                    selectedUserEmailFilter = 'all_users'; 
                    userNameFilterSelect.value = 'all_users'; 
                }
                currentStatusFilter = 'active'; 

                loginPageContainer.classList.add('hidden'); 
                await fetchAndDisplayPlannerData(); 
                
            } else {
                loginErrorMessage.textContent = 'Email not found. You cannot enter this Page. Kindly contact to MIS Executive.';
            }
            loginLoadingState.classList.add('hidden'); 
            loginButton.disabled = false; 
        }
        
        function updateAdminFilterButtons() {
            const isAdmin = currentUserRole && String(currentUserRole).toLowerCase() === 'admin';
            if (isAdmin) {
                adminFilterContainer.classList.remove('hidden');
                if (adminViewPreference === 'self') {
                    viewMyTasksButton.classList.add('active');
                    viewAllTasksButton.classList.remove('active');
                    userNameFilterContainer.classList.add('hidden'); 
                    exportPdfButton.classList.add('hidden'); 
                    exportPdfButton.disabled = true;
                } else { // 'all'
                    viewAllTasksButton.classList.add('active');
                    viewMyTasksButton.classList.remove('active');
                    userNameFilterContainer.classList.remove('hidden'); 
                    exportPdfButton.classList.remove('hidden'); 
                    exportPdfButton.disabled = false;
                }
            } else {
                 adminFilterContainer.classList.add('hidden');
                 userNameFilterContainer.classList.add('hidden');
                 exportPdfButton.classList.add('hidden');
                 exportPdfButton.disabled = true;
            }
        }

        function updateStatusFilterSelect() {
            statusFilterSelect.value = currentStatusFilter;
        }


        function setDefaultDateFilters() {
            const weekRange = getWeekDateRange();
            startDateFilter.value = weekRange.start;
            endDateFilter.value = weekRange.end;
        }

        function handleClearFilters() {
            searchInput.value = '';
            setDefaultDateFilters();
            currentStatusFilter = 'active';
            statusFilterSelect.value = 'active';
            if (currentUserRole && String(currentUserRole).toLowerCase() === 'admin') {
                adminViewPreference = 'self';
                selectedUserEmailFilter = 'all_users';
                userNameFilterSelect.value = 'all_users';
            }
            refreshDashboardContent();
            showToast('Filters cleared!', 'success', 2000);
        }


        function refreshDashboardContent() { 
            if (!currentUserEmail) {
                console.warn("Attempted to refresh dashboard without a logged-in user.");
                return;
            }
            
            const isAdmin = currentUserRole && String(currentUserRole).toLowerCase() === 'admin';
            
            updateAdminFilterButtons(); 

            dateFilterContainer.classList.remove('hidden'); 
            statusFilterContainer.classList.remove('hidden');
            updateStatusFilterSelect(); 
            
            let welcomeMessage = `Welcome, ${currentUserName || currentUserEmail.split('@')[0]}!`;
            if (isAdmin) {
                welcomeMessage += ` <span class="admin-badge">Admin</span>`;
            }
            userNameDisplay.innerHTML = welcomeMessage; 

            const initial = (currentUserName || 'U').charAt(0).toUpperCase();
            userAvatar.src = `https://placehold.co/36x36/E2E8F0/4A5568?text=${initial}`;
            
            filterTasks(); 
        }


        function showDashboard() { 
            loginPageContainer.classList.add('hidden');
            dashboardWrapper.classList.remove('hidden');
            document.body.classList.add('dashboard-visible'); 
            setDefaultDateFilters(); 
            refreshDashboardContent(); 

            searchInput.disabled = false;
            addTaskButtonLink.setAttribute('aria-disabled', 'false');
        }

        async function handleSyncData() {
            if (!currentUserEmail) return; 

            const originalIcon = syncDataButton.innerHTML;
            syncDataButton.innerHTML = `<div class="loader sync-loader"></div>`; 
            syncDataButton.disabled = true;
            errorStateDiv.classList.add('hidden'); 

            try {
                const response = await fetch(PLANNER_API_URL); 
                if (!response.ok) throw new Error(`Planner API Error: ${response.status}`);
                const newData = await response.json();
                if (!Array.isArray(newData)) {
                    throw new Error('Invalid planner data format from API during sync.');
                }
                allPlannerDataGlobal = newData; 
                refreshDashboardContent(); 
                showToast('Data synced successfully!', 'success');
            } catch (error) {
                console.error('Failed to sync data:', error);
                showToast(`Sync failed: ${error.message}`, 'error');
                errorMessageP.textContent = `Sync failed: ${error.message}.`;
                errorStateDiv.classList.remove('hidden');
            } finally {
                syncDataButton.innerHTML = originalIcon; 
                syncDataButton.disabled = false;
            }
        }


        function handleLogout() {
            currentUserEmail = null;
            currentUserName = null;
            currentUserRole = null;
            adminViewPreference = 'self'; 
            currentStatusFilter = 'active';
            selectedUserEmailFilter = 'all_users';
            localStorage.removeItem('loggedInUserEmail');
            allUsersDataGlobal = []; 
            allPlannerDataGlobal = []; 

            dashboardWrapper.classList.add('hidden');
            loginPageContainer.classList.remove('hidden');
            document.body.classList.remove('dashboard-visible'); 
            adminFilterContainer.classList.add('hidden'); 
            userNameFilterContainer.classList.add('hidden');
            dateFilterContainer.classList.add('hidden');
            statusFilterContainer.classList.add('hidden');
            exportPdfButton.classList.add('hidden');
            exportPdfButton.disabled = true;


            emailInput.value = ''; 
            loginErrorMessage.textContent = '';
            loginButton.disabled = true; 
            
            taskGrid.innerHTML = '';
            taskTableContainer.innerHTML = '';
            summaryStatsContainer.innerHTML = '';
            noTasksMessage.classList.add('hidden');
            searchInput.value = ''; 
            searchInput.disabled = true;
            addTaskButtonLink.setAttribute('aria-disabled', 'true');
            
            fetchLoginPrerequisites(); 
        }

        // --- Task Rendering Functions ---
        function renderTasks(tasksToRender) { 
            const isAdmin = currentUserRole && String(currentUserRole).toLowerCase() === 'admin';
            if (isAdmin && adminViewPreference === 'all') {
                renderTasksAsTable(tasksToRender);
            } else {
                renderTasksAsCards(tasksToRender);
            }
            updateSummaryStats(tasksToRender); 
        }

        function renderTasksAsCards(tasksToRender) {
            taskGrid.innerHTML = ''; 
            taskTableContainer.classList.add('hidden'); 
            taskGrid.classList.remove('hidden'); 
            loadingStateDiv.classList.add('hidden'); 

            if (tasksToRender.length === 0) {
                noTasksMessage.classList.remove('hidden'); 
                taskGrid.classList.add('hidden');
            } else {
                noTasksMessage.classList.add('hidden');
                taskGrid.classList.remove('hidden');
            }

            tasksToRender.forEach(task => {
                let currentStatus = task.Status || "Pending"; 
                const dueDateStr = task['Due Date'];
                let dueDate = null;
                if (dueDateStr) {
                    let standardizedDueDate = String(dueDateStr);
                    if (standardizedDueDate.includes('-') && standardizedDueDate.split('-')[1]?.length === 3) {
                        const parts = standardizedDueDate.split('-');
                        const months = {Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06', Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'};
                        if (parts.length === 3 && months[parts[1]]) {
                            standardizedDueDate = `${parts[2]}-${months[parts[1]]}-${parts[0]}`;
                        }
                    }
                    dueDate = new Date(standardizedDueDate + 'T00:00:00Z');
                }

                const today = new Date();
                today.setUTCHours(0,0,0,0); 

                if (String(currentStatus).toLowerCase() !== 'completed' && 
                    String(currentStatus).toLowerCase() !== 'work done in time' && 
                    String(currentStatus).toLowerCase() !== 'work not done in time' && 
                    dueDate && dueDate < today && !task['Completion Date']) {
                    currentStatus = 'Overdue';
                }

                let updateLinkDisplay;
                const statusLowerCase = (task.Status || "").toLowerCase();
                const rawUpdateLink = task['Update Link'];

                if (statusLowerCase === 'completed' || statusLowerCase === 'work done in time' || statusLowerCase === 'work not done in time') {
                    updateLinkDisplay = `<p class="text-sm text-green-600 font-medium text-center py-2">Task Completed</p>`;
                } else {
                    if (!rawUpdateLink || String(rawUpdateLink).trim() === '') {
                        updateLinkDisplay = `<p class="text-sm text-green-600 font-medium text-center py-2">Completed</p>`; 
                    } else {
                        const linkString = String(rawUpdateLink);
                        if (linkString.toLowerCase().includes('<a') && (linkString.includes('href="#"') || linkString.includes('href=""'))) {
                            updateLinkDisplay = `<p class="text-sm text-green-600 font-medium text-center py-2">Completed</p>`; 
                        } else {
                            updateLinkDisplay = `<div class="update-link-container">${linkString.replace(/<a /gi, '<a class="w-full text-center block bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out" ')}</div>`;
                        }
                    }
                }

                const taskCard = document.createElement('div');
                taskCard.className = 'task-card bg-white p-5 rounded-xl shadow-lg border border-slate-200 flex flex-col justify-between';
                
                taskCard.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-lg font-semibold text-slate-800 leading-tight">${task['Task Title'] || 'Untitled Task'}</h3>
                            <span class="status-badge ${getStatusClass(currentStatus)}">${currentStatus}</span>
                        </div>
                        <div class="space-y-2.5 text-sm text-slate-600 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-calendar-alt text-slate-400 mr-2.5 w-4 text-center"></i>
                                <span>Planned:</span>
                                <span class="ml-1 font-medium date-tag bg-slate-100 text-slate-700">${formatDate(task.Planned_Date)}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-hourglass-half text-slate-400 mr-2.5 w-4 text-center"></i>
                                <span>Due:</span>
                                <span class="ml-1 font-medium date-tag ${currentStatus === 'Overdue' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-700'}">${formatDate(task['Due Date'])}</span>
                            </div>
                            ${task['Completion Date'] ? `
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2.5 w-4 text-center"></i>
                                <span>Completed:</span>
                                <span class="ml-1 font-medium date-tag bg-green-100 text-green-700">${formatDate(task['Completion Date'])}</span>
                            </div>` : ''}
                        </div>
                    </div>
                    <div class="mt-auto pt-4 border-t border-slate-200">
                        ${updateLinkDisplay}
                    </div>
                `;
                taskGrid.appendChild(taskCard);
            });
        }

        function renderTasksAsTable(tasksToRender) {
            taskTableContainer.innerHTML = ''; 
            taskGrid.classList.add('hidden'); 
            taskTableContainer.classList.remove('hidden'); 
            loadingStateDiv.classList.add('hidden');

            if (tasksToRender.length === 0) {
                noTasksMessage.classList.remove('hidden');
                taskTableContainer.classList.add('hidden');
                return;
            }
            noTasksMessage.classList.add('hidden');

            const table = document.createElement('table');
            table.className = 'w-full table-auto'; 

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-normal">User</th>
                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-normal">Task Title</th>
                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-normal">Planned Date</th>
                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-normal">Due Date</th>
                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-normal">Completion Date</th>
                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-normal">Status</th>
                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-normal">Action</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            tbody.className = "bg-white divide-y divide-gray-200";

            tasksToRender.forEach(task => {
                const tr = document.createElement('tr');
                
                let currentStatus = task.Status || "Pending"; 
                const dueDateStr = task['Due Date'];
                let dueDate = null;
                if (dueDateStr) {
                    let standardizedDueDate = String(dueDateStr);
                    if (standardizedDueDate.includes('-') && standardizedDueDate.split('-')[1]?.length === 3) {
                        const parts = standardizedDueDate.split('-');
                        const months = {Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06', Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'};
                        if (parts.length === 3 && months[parts[1]]) {
                            standardizedDueDate = `${parts[2]}-${months[parts[1]]}-${parts[0]}`;
                        }
                    }
                    dueDate = new Date(standardizedDueDate + 'T00:00:00Z');
                }
                const today = new Date();
                today.setUTCHours(0,0,0,0); 
                if (String(currentStatus).toLowerCase() !== 'completed' && 
                    String(currentStatus).toLowerCase() !== 'work done in time' && 
                    String(currentStatus).toLowerCase() !== 'work not done in time' && 
                    dueDate && dueDate < today && !task['Completion Date']) {
                    currentStatus = 'Overdue';
                }

                let updateLinkDisplay;
                const statusLowerCase = (task.Status || "").toLowerCase();
                const rawUpdateLink = task['Update Link'];
                if (statusLowerCase === 'completed' || statusLowerCase === 'work done in time' || statusLowerCase === 'work not done in time') {
                    updateLinkDisplay = `<span class="text-sm text-green-600 font-medium">Task Completed</span>`;
                } else {
                    if (!rawUpdateLink || String(rawUpdateLink).trim() === '') {
                         updateLinkDisplay = `<span class="text-sm text-green-600 font-medium">Completed</span>`;
                    } else {
                        const linkString = String(rawUpdateLink);
                        if (linkString.toLowerCase().includes('<a') && (linkString.includes('href="#"') || linkString.includes('href=""'))) {
                            updateLinkDisplay = `<span class="text-sm text-green-600 font-medium">Completed</span>`;
                        } else {
                            updateLinkDisplay = `<div class="update-link-container">${linkString.replace(/<a /gi, '<a class="text-center block bg-blue-500 hover:bg-blue-600 text-white font-medium py-1.5 px-3 rounded-md transition duration-150 ease-in-out text-xs" ')}</div>`;
                        }
                    }
                }

                const taskOwnerEmailAddress = String(task['Email Address'] || '').toLowerCase();
                const ownerDetails = allUsersDataGlobal.find(u => String(u.Email).toLowerCase() === taskOwnerEmailAddress);
                const ownerName = ownerDetails ? ownerDetails['Employee Name'] : taskOwnerEmailAddress;

                tr.innerHTML = `
                    <td class="px-2 py-2 sm:px-4 sm:py-3 text-sm text-gray-900 whitespace-normal break-words" title="${taskOwnerEmailAddress}">${ownerName}</td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3 text-sm text-gray-900 whitespace-normal break-words">${task['Task Title'] || 'Untitled Task'}</td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3 text-sm text-gray-500 whitespace-normal">${formatDate(task.Planned_Date)}</td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3 text-sm text-gray-500 whitespace-normal">${formatDate(task['Due Date'])}</td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3 text-sm text-gray-500 whitespace-normal">${formatDate(task['Completion Date'])}</td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3 whitespace-normal"><span class="status-badge ${getStatusClass(currentStatus)}">${currentStatus}</span></td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3 text-sm font-medium whitespace-normal">${updateLinkDisplay}</td>
                `;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            taskTableContainer.appendChild(table);
        }


        function updateSummaryStats(tasks) {
            const totalTasks = tasks.length;
            let activeTasks = 0; 
            let completedTasks = 0;
            let overdueTasks = 0;
            
            tasks.forEach(task => {
                let status = task.Status || "Pending";
                const statusLower = String(status).toLowerCase();
                const dueDateStr = task['Due Date'];
                let dueDate = null;
                 if (dueDateStr) {
                    let standardizedDueDate = String(dueDateStr);
                    if (standardizedDueDate.includes('-') && standardizedDueDate.split('-')[1]?.length === 3) {
                        const parts = standardizedDueDate.split('-');
                        const months = {Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06', Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'};
                        if (parts.length === 3 && months[parts[1]]) {
                            standardizedDueDate = `${parts[2]}-${months[parts[1]]}-${parts[0]}`;
                        }
                    }
                    dueDate = new Date(standardizedDueDate + 'T00:00:00Z'); 
                }
                const today = new Date();
                today.setUTCHours(0,0,0,0); 

                let isTaskOverdue = false;
                if (statusLower !== 'completed' && statusLower !== 'work done in time' && statusLower !== 'work not done in time' && dueDate && dueDate < today && !task['Completion Date']) {
                    isTaskOverdue = true;
                    overdueTasks++;
                }
                
                if (statusLower === 'completed' || statusLower === 'work done in time' || statusLower === 'work not done in time') {
                    completedTasks++;
                } else if (isTaskOverdue) {
                    activeTasks++;
                } else if (statusLower === 'pending' || statusLower === 'inprogress' || statusLower === 'in progress') {
                    activeTasks++;
                }
            });
            
            summaryStatsContainer.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow border border-[var(--macos-border)] flex items-center">
                    <i class="fas fa-list-alt summary-card-icon text-blue-500"></i>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-1">Total Tasks</h4>
                        <p class="text-2xl font-bold text-gray-800">${totalTasks}</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-[var(--macos-border)] flex items-center">
                     <i class="fas fa-hourglass-half summary-card-icon text-[var(--macos-orange-accent)]"></i>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-1">Active</h4>
                        <p class="text-2xl font-bold text-[var(--macos-orange-accent)]">${activeTasks}</p> 
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-[var(--macos-border)] flex items-center">
                    <i class="fas fa-check-circle summary-card-icon text-[var(--macos-green-accent)]"></i>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-1">Completed</h4>
                        <p class="text-2xl font-bold text-[var(--macos-green-accent)]">${completedTasks}</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-[var(--macos-border)] flex items-center">
                    <i class="fas fa-exclamation-triangle summary-card-icon text-[var(--macos-red-accent)]"></i>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-1">Overdue</h4>
                        <p class="text-2xl font-bold text-[var(--macos-red-accent)]">${overdueTasks}</p>
                    </div>
                </div>
            `;
        }

        function filterTasks() { 
            const searchTerm = searchInput.value.toLowerCase();
            if (!currentUserEmail) return; 
            
            let tasksToConsider;
            const isAdmin = currentUserRole && String(currentUserRole).toLowerCase() === 'admin';
            
            if (isAdmin) {
                if (adminViewPreference === 'self') {
                    tasksToConsider = allPlannerDataGlobal.filter(task => String(task['Email Address']).toLowerCase() === currentUserEmail);
                } else { 
                    if (selectedUserEmailFilter !== 'all_users') {
                        tasksToConsider = allPlannerDataGlobal.filter(task => String(task['Email Address']).toLowerCase() === selectedUserEmailFilter);
                    } else {
                        tasksToConsider = allPlannerDataGlobal;
                    }
                }
            } else {
                tasksToConsider = allPlannerDataGlobal.filter(task => String(task['Email Address']).toLowerCase() === currentUserEmail);
            }

            const startDate = startDateFilter.value;
            const endDate = endDateFilter.value;
            let dateFilteredTasks = tasksToConsider;

            if (startDate && endDate) {
                dateFilteredTasks = tasksToConsider.filter(task => {
                    const plannedDate = task.Planned_Date;
                    if (!plannedDate) return false;
                    
                    let standardizedPlannedDate = plannedDate;
                    if (plannedDate.includes('-') && plannedDate.split('-')[1]?.length === 3) {
                        const parts = plannedDate.split('-');
                        const months = {Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06', Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'};
                        if (parts.length === 3 && months[parts[1]]) {
                            standardizedPlannedDate = `${parts[2]}-${months[parts[1]]}-${parts[0]}`;
                        }
                    }
                    return standardizedPlannedDate >= startDate && standardizedPlannedDate <= endDate;
                });
            }
            
            let statusFilteredTasks = dateFilteredTasks;
            if (currentStatusFilter === 'active') {
                statusFilteredTasks = dateFilteredTasks.filter(task => {
                    const status = String(task.Status || '').toLowerCase();
                    const taskDueDate = task['Due Date'];
                    let isOverdueByDate = false;
                    if (taskDueDate) {
                        let standardizedDueDate = taskDueDate;
                         if (taskDueDate.includes('-') && taskDueDate.split('-')[1]?.length === 3) {
                            const parts = taskDueDate.split('-');
                             const months = {Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06', Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'};
                            if (parts.length === 3 && months[parts[1]]) {
                                standardizedDueDate = `${parts[2]}-${months[parts[1]]}-${parts[0]}`;
                            }
                        }
                        isOverdueByDate = new Date(standardizedDueDate + 'T00:00:00Z') < new Date(new Date().toISOString().split('T')[0] + 'T00:00:00Z');
                    }
                    const isNotExplicitlyCompleted = status !== 'completed' && status !== 'work done in time' && status !== 'work not done in time';
                    
                    return status === 'pending' || status === 'inprogress' || (isOverdueByDate && isNotExplicitlyCompleted && !task['Completion Date']);
                });
            } else if (currentStatusFilter === 'completed_group') { 
                statusFilteredTasks = dateFilteredTasks.filter(task => {
                    const status = String(task.Status || '').toLowerCase();
                    return status === 'work done in time' || status === 'work not done in time';
                });
            } else if (currentStatusFilter === 'completed_in_time') {
                statusFilteredTasks = dateFilteredTasks.filter(task => String(task.Status || '').toLowerCase() === 'work done in time');
            } else if (currentStatusFilter === 'completed_not_in_time') {
                statusFilteredTasks = dateFilteredTasks.filter(task => String(task.Status || '').toLowerCase() === 'work not done in time');
            }
            // If 'all', no additional status filtering needed here as dateFilteredTasks is already the base

            const searchedTasks = statusFilteredTasks.filter(task => {
                const titleMatch = (task['Task Title'] || '').toLowerCase().includes(searchTerm);
                let ownerMatch = false;
                if (isAdmin) { 
                    const taskOwnerEmailAddress = String(task['Email Address'] || '').toLowerCase();
                    const ownerDetails = allUsersDataGlobal.find(u => String(u.Email).toLowerCase() === taskOwnerEmailAddress);
                    const ownerName = ownerDetails ? String(ownerDetails['Employee Name'] || '').toLowerCase() : '';
                    ownerMatch = ownerName.includes(searchTerm) || taskOwnerEmailAddress.includes(searchTerm);
                }
                return titleMatch || ownerMatch;
            });
            
            renderTasks(searchedTasks); 
        }

        function handleExportToPdf() {
            const isAdmin = currentUserRole && String(currentUserRole).toLowerCase() === 'admin';
            if (!isAdmin || adminViewPreference !== 'all') {
                showToast("PDF export is only available for Admins viewing 'All Tasks'.", "error");
                return;
            }

            const tasksToExport = getCurrentFilteredTasksForPdf(); 
            if (tasksToExport.length === 0) {
                showToast("No data to export.", "error");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });

            doc.setFontSize(18);
            doc.text("Weekly Planner Report - All Tasks", 14, 22);
            doc.setFontSize(10);
            doc.text(`Exported on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 14, 30);

            const tableColumn = ["User", "Task Title", "Planned Date", "Due Date", "Completion Date", "Status"];
            const tableRows = [];

            tasksToExport.forEach(task => {
                const taskOwnerEmailAddress = String(task['Email Address'] || '').toLowerCase();
                const ownerDetails = allUsersDataGlobal.find(u => String(u.Email).toLowerCase() === taskOwnerEmailAddress);
                const ownerName = ownerDetails ? ownerDetails['Employee Name'] : taskOwnerEmailAddress;
                
                let currentStatus = task.Status || "Pending";
                const dueDateStr = task['Due Date'];
                let dueDate = null;
                if (dueDateStr) {
                    let standardizedDueDate = String(dueDateStr);
                    if (standardizedDueDate.includes('-') && standardizedDueDate.split('-')[1]?.length === 3) {
                        const parts = standardizedDueDate.split('-');
                        const months = {Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06', Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'};
                        if (parts.length === 3 && months[parts[1]]) {
                            standardizedDueDate = `${parts[2]}-${months[parts[1]]}-${parts[0]}`;
                        }
                    }
                    dueDate = new Date(standardizedDueDate + 'T00:00:00Z');
                }
                const today = new Date();
                today.setUTCHours(0,0,0,0); 
                if (String(currentStatus).toLowerCase() !== 'completed' && 
                    String(currentStatus).toLowerCase() !== 'work done in time' && 
                    String(currentStatus).toLowerCase() !== 'work not done in time' && 
                    dueDate && dueDate < today && !task['Completion Date']) {
                    currentStatus = 'Overdue';
                }


                const taskData = [
                    ownerName,
                    task['Task Title'] || '',
                    formatDate(task.Planned_Date),
                    formatDate(task['Due Date']),
                    formatDate(task['Completion Date']),
                    currentStatus
                ];
                tableRows.push(taskData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 35,
                theme: 'striped', 
                headStyles: { fillColor: [22, 160, 133] }, 
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 40 }, 
                    1: { cellWidth: 'auto'},
                    2: { cellWidth: 25 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 25 },
                    5: { cellWidth: 30 },
                },
                didDrawPage: function (data) {
                    const str = " 2025 Build Wealth Realtors. All rights reserved.";
                    doc.setFontSize(8);
                    const pageSize = doc.internal.pageSize;
                    const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                    doc.text(str, data.settings.margin.left, pageHeight - 10);
                }
            });
            doc.save('weekly_planner_report.pdf');
            showToast("PDF exported successfully!", "success");
        }

        function getCurrentFilteredTasksForPdf() {
            const searchTerm = searchInput.value.toLowerCase();
            let tasksToConsider = allPlannerDataGlobal; 

            if (selectedUserEmailFilter !== 'all_users') {
                tasksToConsider = tasksToConsider.filter(task => String(task['Email Address']).toLowerCase() === selectedUserEmailFilter);
            }

            const startDate = startDateFilter.value;
            const endDate = endDateFilter.value;
            let dateFilteredTasks = tasksToConsider;

            if (startDate && endDate) {
                dateFilteredTasks = tasksToConsider.filter(task => {
                    const plannedDate = task.Planned_Date;
                    if (!plannedDate) return false;
                    let standardizedPlannedDate = plannedDate;
                    if (plannedDate.includes('-') && plannedDate.split('-')[1]?.length === 3) {
                        const parts = plannedDate.split('-');
                        const months = {Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06', Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'};
                        if (parts.length === 3 && months[parts[1]]) {
                            standardizedPlannedDate = `${parts[2]}-${months[parts[1]]}-${parts[0]}`;
                        }
                    }
                    return standardizedPlannedDate >= startDate && standardizedPlannedDate <= endDate;
                });
            }
            
            let statusFilteredTasks = dateFilteredTasks;
            if (currentStatusFilter === 'active') {
                statusFilteredTasks = dateFilteredTasks.filter(task => {
                    const status = String(task.Status || '').toLowerCase();
                    const taskDueDate = task['Due Date'];
                    let isOverdueByDate = false;
                    if (taskDueDate) {
                        let standardizedDueDate = taskDueDate;
                         if (taskDueDate.includes('-') && taskDueDate.split('-')[1]?.length === 3) {
                            const parts = taskDueDate.split('-');
                             const months = {Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06', Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'};
                            if (parts.length === 3 && months[parts[1]]) {
                                standardizedDueDate = `${parts[2]}-${months[parts[1]]}-${parts[0]}`;
                            }
                        }
                        isOverdueByDate = new Date(standardizedDueDate + 'T00:00:00Z') < new Date(new Date().toISOString().split('T')[0] + 'T00:00:00Z');
                    }
                    const isNotExplicitlyCompleted = status !== 'completed' && status !== 'work done in time' && status !== 'work not done in time';
                    return status === 'pending' || status === 'inprogress' || (isOverdueByDate && isNotExplicitlyCompleted && !task['Completion Date']);
                });
            } else if (currentStatusFilter === 'completed_group') { 
                statusFilteredTasks = dateFilteredTasks.filter(task => {
                    const status = String(task.Status || '').toLowerCase();
                    return status === 'work done in time' || status === 'work not done in time';
                });
            } else if (currentStatusFilter === 'completed_in_time') {
                statusFilteredTasks = dateFilteredTasks.filter(task => String(task.Status || '').toLowerCase() === 'work done in time');
            } else if (currentStatusFilter === 'completed_not_in_time') {
                statusFilteredTasks = dateFilteredTasks.filter(task => String(task.Status || '').toLowerCase() === 'work not done in time');
            }

            return statusFilteredTasks.filter(task => {
                const titleMatch = (task['Task Title'] || '').toLowerCase().includes(searchTerm);
                const taskOwnerEmailAddress = String(task['Email Address'] || '').toLowerCase();
                const ownerDetails = allUsersDataGlobal.find(u => String(u.Email).toLowerCase() === taskOwnerEmailAddress);
                const ownerName = ownerDetails ? String(ownerDetails['Employee Name'] || '').toLowerCase() : '';
                const ownerMatch = ownerName.includes(searchTerm) || taskOwnerEmailAddress.includes(searchTerm);
                return titleMatch || ownerMatch;
            });
        }


        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        syncDataButton.addEventListener('click', handleSyncData);
        searchInput.addEventListener('input', filterTasks); 
        startDateFilter.addEventListener('change', filterTasks); 
        endDateFilter.addEventListener('change', filterTasks);   
        statusFilterSelect.addEventListener('change', (event) => {
            currentStatusFilter = event.target.value;
            refreshDashboardContent();
        });
        userNameFilterSelect.addEventListener('change', (event) => {
            selectedUserEmailFilter = event.target.value;
            refreshDashboardContent();
        });
        
        viewMyTasksButton.addEventListener('click', () => {
            if (currentUserRole && String(currentUserRole).toLowerCase() === 'admin') {
                adminViewPreference = 'self';
                selectedUserEmailFilter = 'all_users'; 
                userNameFilterSelect.value = 'all_users';
                refreshDashboardContent(); 
            }
        });
        viewAllTasksButton.addEventListener('click', () => {
            if (currentUserRole && String(currentUserRole).toLowerCase() === 'admin') {
                adminViewPreference = 'all';
                refreshDashboardContent(); 
            }
        });
        exportPdfButton.addEventListener('click', handleExportToPdf);
        clearFiltersButton.addEventListener('click', handleClearFilters);
        
        addTaskButtonLink.addEventListener('click', function(event) {
            if (this.getAttribute('aria-disabled') === 'true') {
                event.preventDefault(); 
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginCurrentYear').textContent = new Date().getFullYear();
            document.getElementById('dashboardCurrentYear').textContent = new Date().getFullYear();
            
            loginButton.disabled = true; 
            setDefaultDateFilters(); 
            statusFilterSelect.value = 'active'; 
            exportPdfButton.disabled = true; 

            fetchLoginPrerequisites().then(() => { 
                const persistedEmail = localStorage.getItem('loggedInUserEmail');
                if (persistedEmail && allUsersDataGlobal.length > 0) { 
                     const foundUser = allUsersDataGlobal.find(user => String(user['Email']).toLowerCase() === persistedEmail);
                     if (foundUser) {
                        currentUserEmail = String(foundUser['Email']).toLowerCase();
                        currentUserName = foundUser['Employee Name'];
                        currentUserRole = foundUser['Role'];
                        
                         if (currentUserRole && String(currentUserRole).toLowerCase() === 'admin') {
                            adminViewPreference = 'self'; 
                            selectedUserEmailFilter = 'all_users';
                         }
                        currentStatusFilter = 'active'; 
                        statusFilterSelect.value = currentStatusFilter; 
                        userNameFilterSelect.value = selectedUserEmailFilter;
                        loginPageContainer.classList.add('hidden'); 
                        fetchAndDisplayPlannerData(); 
                     } else { 
                        localStorage.removeItem('loggedInUserEmail'); 
                        loginPageContainer.classList.remove('hidden'); 
                        dashboardWrapper.classList.add('hidden');
                        loginButton.disabled = allUsersDataGlobal.length === 0; 
                     }
                } else { 
                    loginPageContainer.classList.remove('hidden'); 
                    dashboardWrapper.classList.add('hidden');
                    loginButton.disabled = allUsersDataGlobal.length === 0; 
                }
            });
            
            addTaskButtonLink.setAttribute('aria-disabled', 'true');
        });
    </script>
</body>
</html>
